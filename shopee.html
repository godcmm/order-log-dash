<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแปลงไฟล์ Shopee เป็นใบจัดของ</title>

    <!-- โหลดไลบรารีที่จำเป็นจาก CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }

        .print-area {
            display: none;
        }

        @media print {
            .no-print {
                display: none;
            }

            .print-area {
                display: block;
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons (SVG) ---
        const IconUpload = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-8 h-8 mb-2 text-orange-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>
        );
        const IconFileSpreadsheet = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-8 h-8 mb-2 text-green-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></svg>
        );
        const IconCheckCircle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-8 h-8 mb-2 text-green-600"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></svg>
        );
        const IconCopy = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4 mr-2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></svg>
        );
        const IconAlertCircle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 mr-2"><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>
        );

        // --- Main Component ---
        const App = () => {
            const [shopeeFile, setShopeeFile] = useState(null);
            const [mappingFile, setMappingFile] = useState(null);
            const [skuMap, setSkuMap] = useState({});
            const [processedData, setProcessedData] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [error, setError] = useState('');
            const [debugInfo, setDebugInfo] = useState('');
            const [matchStats, setMatchStats] = useState(null);

            // Helper to clean SKU keys (trim and lowercase)
            const normalizeKey = (key) => {
                if (!key) return '';
                // Trim and lowercase to ensure best match
                return String(key).trim().toLowerCase();
            };

            // Helper to read Excel
            const readExcel = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, { type: 'binary' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            resolve(jsonData);
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = (err) => reject(err);
                    reader.readAsBinaryString(file);
                });
            };

            const handleMappingUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    setMappingFile(file);
                    const data = await readExcel(file);
                    const map = {};
                    let count = 0;

                    // Format: Col 0=Key, Col 1=Name, Col 2=Color, Col 3=Unit
                    data.forEach((row) => {
                        if (row.length >= 1) {
                            const rawKey = row[0];
                            const key = normalizeKey(rawKey);

                            if (key) {
                                map[key] = {
                                    name: row[1] ? String(row[1]).trim() : '',
                                    color: row[2] ? String(row[2]).trim() : '',
                                    unit: row[3] ? String(row[3]).trim() : ''
                                };
                                count++;
                            }
                        }
                    });
                    setSkuMap(map);
                    setDebugInfo(`โหลด SKU เรียบร้อย: ${count} รายการ\n(ตัวอย่าง: ${Object.keys(map).slice(0, 3).join(', ')})`);
                    setError('');
                } catch (err) {
                    setError('อ่านไฟล์ SKU ไม่สำเร็จ: ' + err.message);
                }
            };

            const handleShopeeUpload = (e) => {
                const file = e.target.files[0];
                if (file) setShopeeFile(file);
            };

            // Improved Column Finder: Prioritizes keywords in order
            const getColIndexPriority = (keywords, headers) => {
                for (const keyword of keywords) {
                    const index = headers.findIndex(h => h && String(h).trim().includes(keyword));
                    if (index !== -1) return { index, foundKeyword: keyword };
                }
                return { index: -1, foundKeyword: null };
            };

            const processFiles = async () => {
                if (!shopeeFile) {
                    setError('กรุณาเลือกไฟล์ Shopee ก่อนครับ');
                    return;
                }
                setIsProcessing(true);
                setError('');
                setMatchStats(null);

                try {
                    const rawData = await readExcel(shopeeFile);

                    // 1. Find header row
                    let headerRowIndex = -1;
                    let headers = [];
                    const headerKeywords = ['Order ID', 'หมายเลขคำสั่งซื้อ'];

                    for (let i = 0; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (row && headerKeywords.some(kw => row.some(cell => String(cell).includes(kw)))) {
                            headerRowIndex = i;
                            headers = row;
                            break;
                        }
                    }

                    if (headerRowIndex === -1) throw new Error("ไม่พบหัวตาราง (Order ID) ในไฟล์");

                    // 2. Identify Columns with Priority
                    const colOrder = getColIndexPriority(['Order ID', 'หมายเลขคำสั่งซื้อ'], headers);

                    // Priority for SKU: Look for "Reference No" FIRST, then "Parent SKU"
                    const colSKU = getColIndexPriority(
                        ['เลขที่อ้างอิง SKU', 'SKU Reference No.', 'Reference No.', 'Variation SKU', 'รหัสสินค้า', 'Parent SKU', 'SKU'],
                        headers
                    );

                    const colVarName = getColIndexPriority(['Variation Name', 'ชื่อตัวเลือก'], headers);
                    const colQty = getColIndexPriority(['Quantity', 'จำนวน'], headers);
                    const colShipping = getColIndexPriority(['Shipping Option', 'ตัวเลือกการจัดส่ง'], headers);

                    if (colOrder.index === -1) throw new Error("ไม่พบคอลัมน์ Order ID");
                    if (colSKU.index === -1) throw new Error("ไม่พบคอลัมน์ SKU");

                    // 3. Process Data
                    const ordersMap = new Map();
                    let matchedCount = 0;
                    let totalItems = 0;

                    for (let i = headerRowIndex + 1; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (!row || row.length === 0) continue;

                        const orderId = row[colOrder.index];
                        if (!orderId) continue;

                        const skuRaw = row[colSKU.index] ? String(row[colSKU.index]).trim() : '';
                        const variant = row[colVarName.index] ? String(row[colVarName.index]).trim() : '';
                        const qty = row[colQty.index] || 0;
                        const shipping = colShipping.index !== -1 ? (row[colShipping.index] || '') : '';

                        // Logic: Mapping
                        const searchKey = normalizeKey(skuRaw);

                        let finalName = skuRaw;     // Default: Shopee SKU
                        let finalColor = variant;   // Default: Shopee Variant
                        let finalUnit = '';         // Default: Empty

                        const mappedItem = skuMap[searchKey];
                        totalItems++;

                        if (mappedItem) {
                            matchedCount++;
                            // Rule 1: Item Name from Col B
                            if (mappedItem.name) finalName = mappedItem.name;

                            // Rule 2: Color from Col C (Always overwrite if found in map, even if empty)
                            finalColor = mappedItem.color;

                            // Rule 3: Unit from Col D
                            finalUnit = mappedItem.unit;
                        }

                        const item = { orderId, skuRaw, name: finalName, color: finalColor, qty, unit: finalUnit, shipping };

                        if (!ordersMap.has(orderId)) {
                            ordersMap.set(orderId, []);
                        }
                        ordersMap.get(orderId).push(item);
                    }

                    // 4. Update Stats for debugging
                    setMatchStats({
                        total: totalItems,
                        matched: matchedCount,
                        skuColumnUsed: headers[colSKU.index] // Show user which column we picked
                    });

                    // Flatten for table
                    const finalTableData = [];
                    let runningNumber = 1;

                    ordersMap.forEach((items, orderId) => {
                        items.forEach((item, index) => {
                            finalTableData.push({
                                ...item,
                                isFirstItem: index === 0,
                                isLastItem: index === items.length - 1,
                                displayIndex: index === 0 ? runningNumber : '',
                                displaySource: 's'
                            });
                        });
                        runningNumber++;
                    });

                    setProcessedData(finalTableData);

                } catch (err) {
                    setError('เกิดข้อผิดพลาด: ' + err.message);
                    console.error(err);
                } finally {
                    setIsProcessing(false);
                }
            };

            const copyToClipboard = () => {
                const range = document.createRange();
                const table = document.getElementById('result-table');
                range.selectNode(table);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                try {
                    document.execCommand('copy');
                    alert('คัดลอกตารางแล้ว! ไปวางใน Google Sheet ได้เลย');
                } catch (e) {
                    alert('Copy ไม่สำเร็จ');
                }
                window.getSelection().removeAllRanges();
            };

            return (
                <div className="max-w-5xl mx-auto p-6 space-y-8">
                    <div className="text-center no-print">
                        <h1 className="text-3xl font-bold text-blue-900 mb-2">ระบบแปลงไฟล์ Shopee {`->`} ใบจัดของ</h1>
                        <p className="text-gray-600">เวอร์ชันรันบนเว็บ (HTML Only)</p>
                    </div>

                    {/* Upload Section */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 no-print">

                        {/* SKU Mapping */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div className="flex items-center mb-4 space-x-2">
                                <div className="p-2 bg-green-100 rounded-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 text-green-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></svg>
                                </div>
                                <h2 className="font-semibold text-lg">1. ไฟล์ SKU มาตรฐาน (ถ้ามี)</h2>
                            </div>
                            <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors relative cursor-pointer">
                                <input type="file" accept=".xlsx, .xls, .csv" onChange={handleMappingUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                {mappingFile ? (
                                    <div className="text-green-600 flex flex-col items-center">
                                        <IconCheckCircle />
                                        <span className="font-medium truncate max-w-xs">{mappingFile.name}</span>
                                        <pre className="text-xs text-gray-400 mt-2 text-left bg-gray-50 p-2 rounded w-full overflow-hidden">
                                            {debugInfo || 'โหลดข้อมูลเรียบร้อย'}
                                        </pre>
                                    </div>
                                ) : (
                                    <div className="text-gray-400">
                                        <p>คลิกเพื่อเลือกไฟล์</p>
                                        <div className="text-xs mt-2 text-gray-500 text-left mx-auto max-w-[200px]">
                                            <p>A: รหัส SKU (สำหรับเทียบ)</p>
                                            <p>B: ชื่อสินค้า</p>
                                            <p>C: สี</p>
                                            <p>D: หน่วย</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Shopee Upload */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div className="flex items-center mb-4 space-x-2">
                                <div className="p-2 bg-orange-100 rounded-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 text-orange-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>
                                </div>
                                <h2 className="font-semibold text-lg">2. ไฟล์คำสั่งซื้อ Shopee</h2>
                            </div>
                            <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors relative cursor-pointer">
                                <input type="file" accept=".xlsx, .xls, .csv" onChange={handleShopeeUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                {shopeeFile ? (
                                    <div className="text-orange-600 flex flex-col items-center">
                                        <IconFileSpreadsheet />
                                        <span className="font-medium truncate max-w-xs">{shopeeFile.name}</span>
                                    </div>
                                ) : (
                                    <div className="text-gray-400">
                                        <p>คลิกเพื่อเลือกไฟล์</p>
                                        <p className="text-xs mt-2 text-gray-400">(ไฟล์ Export จาก Shopee)</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Process Button */}
                    <div className="flex flex-col items-center justify-center no-print space-y-4">
                        <button
                            onClick={processFiles}
                            disabled={!shopeeFile || isProcessing}
                            className={`px-8 py-3 rounded-lg font-bold text-white shadow-lg transition-all 
                                ${(!shopeeFile) ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 hover:scale-105 active:scale-95'}`}
                        >
                            {isProcessing ? 'กำลังประมวลผล...' : 'สร้างตารางรายการ'}
                        </button>

                        {/* Debug / Status Info */}
                        {matchStats && (
                            <div className="text-sm bg-blue-50 text-blue-800 p-3 rounded-lg border border-blue-200">
                                <p><strong>สถานะการจับคู่:</strong> เจอ {matchStats.matched} จาก {matchStats.total} รายการ</p>
                                <p><strong>ใช้คอลัมน์ SKU จากหัวข้อ:</strong> "{matchStats.skuColumnUsed}"</p>
                                {matchStats.matched === 0 && (
                                    <p className="text-red-500 mt-1">⚠️ ไม่เจอคู่เลย! กรุณาเช็คว่าชื่อคอลัมน์ SKU ในไฟล์ Shopee ตรงกับที่ระบบหา หรือรหัส SKU เขียนเหมือนกันหรือไม่</p>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Error */}
                    {error && (
                        <div className="flex items-center justify-center text-red-600 bg-red-50 p-3 rounded-lg no-print">
                            <IconAlertCircle />
                            {error}
                        </div>
                    )}

                    {/* Table */}
                    {processedData.length > 0 && (
                        <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                            <div className="p-4 bg-gray-50 border-b flex justify-between items-center sticky top-0 no-print">
                                <h3 className="font-bold text-gray-700">ผลลัพธ์ ({processedData.filter(x => x.isFirstItem).length} ออเดอร์)</h3>
                                <button
                                    onClick={copyToClipboard}
                                    className="flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                                >
                                    <IconCopy />
                                    คัดลอกตาราง
                                </button>
                            </div>

                            <div className="overflow-x-auto p-4">
                                <table id="result-table" className="w-full border-collapse text-sm text-black">
                                    <thead>
                                        <tr className="bg-gray-200 text-gray-700">
                                            <th className="border border-gray-400 px-2 py-2 w-12 text-center">ลำดับ</th>
                                            <th className="border border-gray-400 px-2 py-2 w-12 text-center">ที่มา</th>
                                            <th className="border border-gray-400 px-4 py-2 text-left">รายการ</th>
                                            <th className="border border-gray-400 px-2 py-2 w-32 text-center">สี</th>
                                            <th className="border border-gray-400 px-2 py-2 w-16 text-center">จำนวน</th>
                                            <th className="border border-gray-400 px-2 py-2 w-20 text-center">หน่วย</th>
                                            <th className="border border-gray-400 px-2 py-2 w-16 text-center">ตัด</th>
                                            <th className="border border-gray-400 px-2 py-2 w-32 text-center">Note</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {processedData.map((row, idx) => (
                                            <tr key={idx} className={row.isLastItem ? 'border-b-2 border-black' : 'border-b border-gray-300'}>
                                                <td className="border-r border-l border-gray-400 px-2 py-2 text-center align-top font-bold bg-white">
                                                    {row.displayIndex}
                                                </td>
                                                <td className="border-r border-gray-400 px-2 py-2 text-center align-top bg-white">
                                                    {row.isFirstItem ? row.displaySource : ''}
                                                </td>
                                                <td className="border-r border-gray-400 px-4 py-2 align-top bg-white">
                                                    {row.name}
                                                    {row.name === row.skuRaw && row.skuRaw !== '' && (
                                                        <div className="text-xs text-gray-400 mt-1">{row.skuRaw}</div>
                                                    )}
                                                </td>
                                                <td className="border-r border-gray-400 px-2 py-2 text-center align-top bg-white">
                                                    {row.color}
                                                </td>
                                                <td className="border-r border-gray-400 px-2 py-2 text-center align-top bg-white font-bold">
                                                    {row.qty}
                                                </td>
                                                <td className="border-r border-gray-400 px-2 py-2 text-center align-top bg-white">
                                                    {row.unit}
                                                </td>
                                                <td className="border-r border-gray-400 px-2 py-2 text-center align-top bg-white"></td>
                                                <td className="border-r border-gray-400 px-2 py-2 text-center align-top bg-white text-xs">
                                                    {row.isFirstItem ? row.shipping : ''}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
